#+title: cort.el
#+author: conao3

[[https://github.com/conao3/cort.el][https://raw.githubusercontent.com/conao3/files/master/blob/headers/png/cort.el.png]]

[[https://github.com/conao3/cort.el/blob/master/LICENSE][https://img.shields.io/github/license/conao3/cort.el.svg?style=flat-square]]
[[https://github.com/conao3/cort.el/releases][https://img.shields.io/github/tag/conao3/cort.el.svg?style=flat-square]]
[[https://melpa.org/#/cort][https://melpa.org/packages/cort-badge.svg]]

A lightweight and flexible unit testing framework for Emacs Lisp.

[[./imgs/capture.png]]

* Overview

cort.el provides a simple yet powerful way to write unit tests for your Emacs Lisp packages. Unlike the built-in ~ert.el~, cort.el focuses on clear, readable error messages and a straightforward testing syntax.

Key features:
- Simple, intuitive test definition syntax
- Support for any comparison function (~eq~, ~equal~, ~=~, etc.)
- Built-in error testing with ~:cort-error~
- Compatible with Emacs 22 and later

* Installation

** From MELPA

#+begin_src emacs-lisp
(require 'cort)
#+end_src

Or with ~use-package~:

#+begin_src emacs-lisp
(use-package cort)
#+end_src

** Manual Installation

1. Place ~cort.el~ in your package root folder
2. Create a test file named ~[package-name]-tests.el~
3. Optionally set up a ~Makefile~ for automated testing

* Quick Start

Define your tests using ~cort-deftest~:

#+begin_src emacs-lisp
(require 'cort)

(cort-deftest simple-arithmetic
  '((:= (+ 4 5) 9)
    (:= (- 4 5) -1)
    (:= (* 4 5) 20)))

(cort-deftest string-operations
  '((:string= (concat "foo" "bar") "foobar")
    (:equal (split-string "a,b,c" ",") '("a" "b" "c"))))
#+end_src

Run your tests with:

#+begin_src emacs-lisp
(cort-test-run)
#+end_src

* Usage

** Basic Test Cases

Test configurations accept lists of the form ~(:KEY GIVEN EXPECT)~, where ~KEY~ is any comparison function that returns a boolean:

#+begin_src emacs-lisp
(cort-deftest comparison-examples
  '((:eq 'a 'a)              ; symbol equality
    (:equal '(1 2) '(1 2))   ; structural equality
    (:= 100 100)             ; numeric equality
    (:string= "foo" "foo"))) ; string equality
#+end_src

This flexibility allows you to use any comparison function, making your tests expressive and readable.

** Testing for Errors

Use ~:cort-error~ to verify that code raises expected errors:

#+begin_src emacs-lisp
(cort-deftest error-handling
  '((:cort-error 'void-function (undefined-func 'a))
    (:cort-error 'arith-error (/ 1 0))
    (:cort-error 'void-variable (+ 1 undefined-var))))
#+end_src

The first argument should be an [[https://www.gnu.org/software/emacs/manual/html_node/elisp/Standard-Errors.html#Standard-Errors][error symbol]], and the second is the form expected to raise that error.

** Using Macros for Test Generation

When writing many similar tests, use macros to reduce repetition:

#+begin_src emacs-lisp
;; Define a helper macro for macro expansion tests
(defmacro match-expansion (form expect)
  `(:equal (macroexpand ',form) ,expect))

;; Use it in your tests
(cort-deftest my-macro-test
  (match-expansion
   (my-package-require 'use-package)
   '(require 'use-package)))
#+end_src

This approach keeps your test definitions concise and maintainable.

* CI Integration

** Makefile Example

#+begin_src makefile
TOP       := $(dir $(lastword $(MAKEFILE_LIST)))
EMACS     ?= emacs
LOAD_PATH := -L $(TOP)
BATCH     := $(EMACS) -Q --batch $(LOAD_PATH)

ELS       := cort.el
ELCS      := $(ELS:.el=.elc)

all: build

build: $(ELCS)

%.elc: %.el
	@printf "Compiling $<\n"
	@$(BATCH) -f batch-byte-compile $<

check: build
	$(BATCH) -l cort-tests.el -f cort-test-run

clean:
	-find . -type f -name "*.elc" | xargs rm
#+end_src

** GitHub Actions

#+begin_src yaml
name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        emacs-version: ['27.2', '28.2', '29.1']
    steps:
      - uses: actions/checkout@v4
      - uses: purcell/setup-emacs@master
        with:
          version: ${{ matrix.emacs-version }}
      - run: make check
#+end_src

* Migration Guide

** v5.0 to v6.0

- All functions and macros now use the ~cort-test~ prefix
- Removed environment keywords (~:cort-if~, ~:cort-emacs<~, etc.)
- Use standard condition functions in test definitions instead

** v4.0 to v5.0

- The second argument to ~cort-deftest~ now expects a list of forms
- This change enables shorter, cleaner test definitions

** v3.0 to v4.0

- Renamed from ~cort~ to ~cort-test~
- MELPA ignores ~*-test.el~ and ~*-tests.el~ by default, so this naming works well with package distribution

** v2.0 to v3.0

- Renamed from ~srt~ to ~cort~
- All ~srt~ prefixes changed to ~cort~

** v1.0 to v2.0

- The ~:error~ flag changed to ~:srt-error~

* Contributing

Contributions are welcome. Feel free to open issues or submit pull requests on [[https://github.com/conao3/cort.el][GitHub]].

The test suite runs across multiple Emacs versions, so don't worry about setting up a complete local testing environment. Submit your PR and the CI will verify compatibility.

* License

#+begin_example
GNU General Public License v3.0
Copyright (c) Naoya Yamashita - https://conao3.com
https://github.com/conao3/cort.el/blob/master/LICENSE
#+end_example

* Author

- Naoya Yamashita ([[https://github.com/conao3][conao3]])

* Contributors

- Kazuya Sugiyama ([[https://github.com/Kzflute][Kzflute]])

* Acknowledgments

Thanks to the [[http://emacs-jp.github.io/][Emacs-JP]] community for their valuable feedback and suggestions during development.
